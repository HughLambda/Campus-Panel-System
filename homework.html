<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>高一17班作业登记系统</title>
    <style>
        /* 样式部分保持不变 */
        :root {
            --primary-color: #2196F3;
            --hover-color: #1976D2;
        }

        body {
            font-family: "Microsoft YaHei", sans-serif;
            padding: 20px;
            background-color: #f5f5f5;
        }

        .header {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: relative;
        }

        .system-title {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary-color);
            cursor: pointer;
        }

        .date-selector {
            position: absolute;
            right: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .date-selector label {
            font-weight: bold;
        }

        .container {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 30px;
            opacity: 0.5;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .container.active {
            opacity: 1;
            pointer-events: auto;
        }

        .subject-box {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .search-box {
            position: relative;
            margin-bottom: 10px;
        }

        input[type="text"], input[type="date"], input[type="password"] {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .suggestions {
            position: absolute;
            width: 100%;
            background: white;
            border: 1px solid #ddd;
            display: none;
            z-index: 100;
        }

        .suggestion-item {
            padding: 8px;
            cursor: pointer;
        }

        .suggestion-item:hover {
            background-color: #f0f0f0;
        }

        .unsubmitted-list {
            list-style: none;
            padding: 0;
            margin: 10px 0 0 0;
        }

        .unsubmitted-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            margin: 4px 0;
            background-color: #fff3e0;
            border-radius: 4px;
        }

        .delete-btn {
            color: #f44336;
            cursor: pointer;
            margin-left: 10px;
        }

        .stats-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 30px;
        }

        .stats-window {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .stats-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 15px;
            color: var(--primary-color);
        }

        .stats-item {
            margin-bottom: 10px;
            padding: 8px;
            background-color: #f8f9fa;
            border-radius: 4px;
        }

        .stats-total {
            font-weight: bold;
            margin-top: 10px;
            color: #f44336;
        }

        .subject-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
            color: var(--primary-color);
        }

        .date-picker {
            margin-bottom: 15px;
        }

        .date-picker label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .date-range-picker {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .date-range-picker input {
            flex: 1;
        }

        .student-stat-item {
            margin-bottom: 10px;
            padding: 10px;
            background-color: #f0f4f8;
            border-radius: 4px;
        }

        .student-stat-name {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .student-stat-details {
            margin-left: 10px;
        }

        .password-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            z-index: 1000;
        }

        .password-modal input {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .password-modal button {
            padding: 8px 16px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .password-modal button:hover {
            background-color: var(--hover-color);
        }

        .close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            cursor: pointer;
            font-size: 20px;
            color: #666;
        }

        .close-btn:hover {
            color: #000;
        }

        .delete-password-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            z-index: 1000;
        }

        .delete-password-modal input {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .delete-password-modal button {
            padding: 8px 16px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .delete-password-modal button:hover {
            background-color: var(--hover-color);
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .button-group button {
            padding: 8px 16px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .button-group button:hover {
            background-color: var(--hover-color);
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="system-title" ondblclick="showPasswordModal()">17班作业登记系统</div>
        <div class="date-selector">
            <label for="currentDate">选择日期：</label>
            <input type="date" id="currentDate" value="${new Date().toISOString().split('T')[0]}">
        </div>
    </div>

    <div class="container">
        <!-- 科目区块动态生成 -->
    </div>

    <div class="stats-container">
        <div class="stats-window">
            <div class="stats-title">当日未交作业情况</div>
            <div id="realTimeStats"></div>
        </div>

        <div class="stats-window">
            <div class="stats-title">按日期统计</div>
            <div class="date-range-picker">
                <input type="date" id="startDate" placeholder="开始日期">
                <span>至</span>
                <input type="date" id="endDate" placeholder="结束日期">
            </div>
            <div class="button-group">
                <button onclick="updateDateStats()">查询</button>
                <button onclick="saveStatsToTxt()">保存为TXT</button>
            </div>
            <div id="dateStats"></div>
        </div>
    </div>

    <div class="password-modal" id="passwordModal">
        <div class="close-btn" onclick="closePasswordModal()">×</div>
        <h3>修改密码</h3>
        <input type="password" id="oldPassword" placeholder="原密码">
        <input type="password" id="newPassword" placeholder="新密码">
        <button onclick="changePassword()">修改</button>
    </div>

    <div class="delete-password-modal" id="deletePasswordModal">
        <div class="close-btn" onclick="closeDeletePasswordModal()">×</div>
        <h3>请输入删除密码</h3>
        <input type="password" id="deletePassword" placeholder="删除密码">
        <button onclick="confirmDelete()">确认</button>
    </div>

    <script>
        // 完整拼音映射
        const pinyinMap = {
            'zxy':'周小媛', 'zwj':'祝文珺', 'jsc':'蒋思辰', 'hsq':'华偲祺', 'yjh':'杨佳禾',
            'zxl':'邹欣璐', 'fr':'方然', 'szt':'盛子桐', 'fzr':'方梓瑞', 'wy':'吴钺',
            'zxm':'曾炫铭', 'zmyyp':'郑马扬鹏', 'whz':'翁涵峥', 'md':'梅朵', 'yhg':'应弘罡',
            'czh':'陈梓灏', 'fyk':'方一可', 'hyx':'胡语宵', 'hyc':'胡益铖', 'myl':'毛飏乐',
            'wyc':'王艺成', 'ckr':'陈楷瑞', 'cty':'柴天乙', 'zy':'郑扬', 'hcx':'何楚璇',
            'dhl':'杜和林', 'ykh':'颜楷恒', 'psr':'潘思汝', 'czq':'曹子祺', 'xym':'徐一鸣',
            'ljc':'李嘉诚', 'yrd':'虞仁达', 'syk':'单奕康', 'ft':'方婷', 'ztr':'郑天瑞',
            'yzg':'余治国', 'lmc':'李铭宸', 'fz':'方喆', 'zjm':'赵璟铭', 'syj':'盛云江',
            'cjx':'陈佶轩', 'gyx':'郭雨欣', 'wtc':'吴天晨', 'jrh':'江儒鸿', 'wlh':'魏凌浩',
            'wlr':'魏凌瑞'
        };

        // 数据结构调整为按日期存储
        let data = loadData(); // 从 localStorage 加载数据
        const subjects = ['语文', '数学', '英语', '物理', '化学', '生物', '通用', '信息'];
        const students = Object.values(pinyinMap);
        let currentPassword = localStorage.getItem('password') || '17ss.+'; // 从 localStorage 加载密码
        let deleteTarget = null; // 用于存储待删除的学生信息

        // 初始化科目容器
        const container = document.querySelector('.container');
        subjects.forEach(subject => {
            const html = `
                <div class="subject-box">
                    <div class="subject-title">${subject}</div>
                    <div class="search-box">
                        <input type="text" placeholder="输入姓名首字母" data-subject="${subject}" disabled>
                        <div class="suggestions"></div>
                    </div>
                    <ul class="unsubmitted-list" data-subject="${subject}"></ul>
                </div>
            `;
            container.innerHTML += html;
        });

        // 事件监听
        document.getElementById('currentDate').addEventListener('change', function() {
            const selectedDate = this.value;
            const container = document.querySelector('.container');
            const inputs = container.querySelectorAll('input[type="text"]');
            
            if (selectedDate) {
                container.classList.add('active');
                inputs.forEach(input => input.disabled = false);
                updateAll();
            } else {
                container.classList.remove('active');
                inputs.forEach(input => input.disabled = true);
            }
        });

        // 事件委托处理
        document.addEventListener('input', handleInput);
        document.addEventListener('click', handleClick);

        function handleInput(e) {
            if (e.target.matches('input[type="text"]')) {
                const input = e.target.value.toLowerCase();
                const suggestions = e.target.nextElementSibling;
                
                if (input) {
                    const matches = students.filter(name => {
                        const key = Object.keys(pinyinMap).find(key => pinyinMap[key] === name);
                        return key && key.startsWith(input);
                    });
                    
                    suggestions.innerHTML = matches.map(name => `
                        <div class="suggestion-item">${name}</div>
                    `).join('');
                    suggestions.style.display = 'block';
                } else {
                    suggestions.style.display = 'none';
                }
            }
        }

        function handleClick(e) {
            if (e.target.classList.contains('suggestion-item')) {
                const selectedDate = document.getElementById('currentDate').value;
                if (!selectedDate) return;

                if (!data[selectedDate]) data[selectedDate] = subjects.reduce((o,s)=>(o[s]=[],o),{});

                const name = e.target.textContent;
                const subject = e.target.closest('.subject-box').querySelector('.subject-title').textContent;
                
                if (!data[selectedDate][subject].includes(name)) {
                    data[selectedDate][subject].push(name);
                    saveData(); // 保存数据到 localStorage
                    updateAll();
                }
            }

            if (e.target.classList.contains('delete-btn')) {
                const item = e.target.closest('.unsubmitted-item');
                const name = item.textContent.replace('×', '').trim();
                const subject = item.closest('.subject-box').querySelector('.subject-title').textContent;
                const selectedDate = document.getElementById('currentDate').value;

                deleteTarget = { name, subject, selectedDate };
                showDeletePasswordModal();
            }
        }

        function updateLists() {
            const selectedDate = document.getElementById('currentDate').value;
            if (!selectedDate || !data[selectedDate]) return;

            subjects.forEach(subject => {
                const list = document.querySelector(`.unsubmitted-list[data-subject="${subject}"]`);
                list.innerHTML = (data[selectedDate][subject] || []).map(name => `
                    <li class="unsubmitted-item">
                        ${name}
                        <span class="delete-btn">×</span>
                    </li>
                `).join('');
            });
        }

        function updateRealTimeStats() {
            const selectedDate = document.getElementById('currentDate').value;
            const statsContainer = document.getElementById('realTimeStats');
            let html = '';

            if (selectedDate && data[selectedDate]) {
                subjects.forEach(subj => {
                    const names = data[selectedDate][subj] || [];
                    if (names.length > 0) {
                        html += `<div class="stats-item">
                            <strong>${subj}:</strong> ${names.join(', ')}
                        </div>`;
                    }
                });

                const total = Object.values(data[selectedDate]).flat().length;
                html += `<div class="stats-total">当日总计: ${total}</div>`;
            } else {
                html = '<div>今日暂无未交记录</div>';
            }

            statsContainer.innerHTML = html;
        }

        function updateDateStats() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const container = document.getElementById('dateStats');
            let html = '';

            if (!startDate || !endDate) {
                container.innerHTML = '<div>请选择开始和结束日期</div>';
                return;
            }

            const dateRange = getDatesInRange(startDate, endDate);
            const studentStats = {};

            dateRange.forEach(date => {
                if (data[date]) {
                    subjects.forEach(subj => {
                        const names = data[date][subj] || [];
                        names.forEach(name => {
                            if (!studentStats[name]) {
                                studentStats[name] = { count: 0, subjects: {} };
                            }
                            studentStats[name].count += 1;
                            if (!studentStats[name].subjects[subj]) {
                                studentStats[name].subjects[subj] = [];
                            }
                            studentStats[name].subjects[subj].push(date);
                        });
                    });
                }
            });

            if (Object.keys(studentStats).length > 0) {
                html = '<div class="stats-title">学生未交作业统计</div>';
                Object.entries(studentStats).forEach(([name, stats]) => {
                    html += `
                        <div class="student-stat-item">
                            <div class="student-stat-name">${name}</div>
                            <div class="student-stat-details">
                                <div>未交次数: ${stats.count}</div>
                                <div>未交科目及日期:</div>
                                <ul>
                                    ${Object.entries(stats.subjects).map(([subj, dates]) => `
                                        <li>${subj} (${dates.join(', ')})</li>
                                    `).join('')}
                                </ul>
                            </div>
                        </div>
                    `;
                });
            } else {
                html = '<div>所选日期范围内无未交记录</div>';
            }

            container.innerHTML = html;
        }

        function getDatesInRange(startDate, endDate) {
            const dates = [];
            let currentDate = new Date(startDate);
            const end = new Date(endDate);

            while (currentDate <= end) {
                dates.push(currentDate.toISOString().split('T')[0]); // 使用 YYYY-MM-DD 格式
                currentDate.setDate(currentDate.getDate() + 1);
            }

            return dates;
        }

        function updateAll() {
            updateLists();
            updateRealTimeStats();
        }

        function showPasswordModal() {
            document.getElementById('passwordModal').style.display = 'block';
        }

        function closePasswordModal() {
            document.getElementById('passwordModal').style.display = 'none';
        }

        function showDeletePasswordModal() {
            document.getElementById('deletePasswordModal').style.display = 'block';
        }

        function closeDeletePasswordModal() {
            document.getElementById('deletePasswordModal').style.display = 'none';
        }

        // 点击模态框外部关闭窗口
        window.onclick = function(event) {
            const passwordModal = document.getElementById('passwordModal');
            const deletePasswordModal = document.getElementById('deletePasswordModal');
            if (event.target === passwordModal) {
                passwordModal.style.display = 'none';
            }
            if (event.target === deletePasswordModal) {
                deletePasswordModal.style.display = 'none';
            }
        };

        function changePassword() {
            const oldPassword = document.getElementById('oldPassword').value;
            const newPassword = document.getElementById('newPassword').value;

            if (oldPassword === currentPassword) {
                currentPassword = newPassword;
                localStorage.setItem('password', newPassword); // 保存新密码到 localStorage
                alert('密码修改成功');
                closePasswordModal();
            } else {
                alert('原密码错误');
            }
        }

        function confirmDelete() {
            const password = document.getElementById('deletePassword').value;
            if (password === currentPassword) {
                if (deleteTarget && data[deleteTarget.selectedDate] && data[deleteTarget.selectedDate][deleteTarget.subject]) {
                    data[deleteTarget.selectedDate][deleteTarget.subject] = data[deleteTarget.selectedDate][deleteTarget.subject].filter(n => n !== deleteTarget.name);
                    saveData(); // 保存数据到 localStorage
                    updateAll();
                }
                closeDeletePasswordModal();
            } else {
                alert('密码错误');
            }
        }

        function saveStatsToTxt() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;

            if (!startDate || !endDate) {
                alert('请选择开始和结束日期');
                return;
            }

            const dateRange = getDatesInRange(startDate, endDate);
            const studentStats = {};

            dateRange.forEach(date => {
                if (data[date]) {
                    subjects.forEach(subj => {
                        const names = data[date][subj] || [];
                        names.forEach(name => {
                            if (!studentStats[name]) {
                                studentStats[name] = { count: 0, subjects: {} };
                            }
                            studentStats[name].count += 1;
                            if (!studentStats[name].subjects[subj]) {
                                studentStats[name].subjects[subj] = [];
                            }
                            studentStats[name].subjects[subj].push(date);
                        });
                    });
                }
            });

            let txtContent = '学生未交作业统计\n\n';
            Object.entries(studentStats).forEach(([name, stats]) => {
                txtContent += `姓名: ${name}\n`;
                txtContent += `未交次数: ${stats.count}\n`;
                txtContent += `未交科目及日期:\n`;
                Object.entries(stats.subjects).forEach(([subj, dates]) => {
                    txtContent += `  - ${subj} (${dates.join(', ')})\n`;
                });
                txtContent += '\n';
            });

            const blob = new Blob([txtContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `未交作业统计_${startDate}_${endDate}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // 从 localStorage 加载数据
        function loadData() {
            const savedData = localStorage.getItem('homeworkData');
            return savedData ? JSON.parse(savedData) : {};
        }

        // 保存数据到 localStorage
        function saveData() {
            localStorage.setItem('homeworkData', JSON.stringify(data));
        }

        // 初始化
        updateAll();
    </script>
</body>
</html>        